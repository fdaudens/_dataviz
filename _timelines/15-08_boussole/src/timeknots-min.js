var TimeKnots={draw:function(t,e,o){var i={width:620,height:100,radius:10,lineWidth:4,color:"#999",background:"#FFF",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:!0,showLabels:!1,labelFormat:"%Y/%m/%d %H:%M:%S",addNow:!1,seriesColor:d3.scale.category20()};if(void 0!=o)for(var r in o)i[r]=o[r];0!=i.addNow&&e.push({date:new Date,name:i.addNowLabel||"Today"});var a=d3.select(t).append("div").style("opacity",0).style("position","absolute").style("font-family","Arial").style("font-size","12px").style("font-weight","300").style("background","rgba(0,0,0,0.5)").style("color","white").style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px"),n=d3.select(t).append("svg").attr("viewBox","0 0 "+i.width+" "+i.height).attr("preserveAspectRatio","xMidYMid meet"),l=e.map(function(t){return Date.parse(t.date)}),s=d3.max(l),d=d3.min(l),h=1.5*(d3.max(e.map(function(t){return t.radius}))||i.radius)+i.lineWidth,u=i.horizontalLayout?(i.width-2*h)/(s-d):(i.height-2*h)/(s-d),c=[];if(s==d&&(u=0,h=i.horizontalLayout?i.width/2:i.height/2),n.append("line").attr("class","timeline-line").attr("x1",function(){return i.horizontalLayout?h:Math.floor(i.width/2)}).attr("x2",function(){return i.horizontalLayout?i.width-h:Math.floor(i.width/2)}).attr("y1",function(){return i.horizontalLayout?Math.floor(i.height/2):h}).attr("y2",function(){return i.horizontalLayout?Math.floor(i.height/2):i.height-h}).style("stroke",i.color).style("stroke-width",i.lineWidth),n.selectAll("circle").data(e).enter().append("circle").attr("class","timeline-event").attr("r",function(t){return void 0!=t.radius?t.radius:i.radius}).style("stroke",function(t){return void 0!=t.color?t.color:void 0!=t.series?(c.indexOf(t.series)<0&&c.push(t.series),console.log(t.series,c,c.indexOf(t.series)),i.seriesColor(c.indexOf(t.series))):i.color}).style("stroke-width",function(t){return void 0!=t.lineWidth?t.lineWidth:i.lineWidth}).style("fill",function(t){return void 0!=t.background?t.background:i.background}).attr("cy",function(t){return Math.floor(i.horizontalLayout?i.height/2:u*(new Date(t.date).getTime()-d)+h)}).attr("cx",function(t){if(i.horizontalLayout){var e=Math.floor(u*(new Date(t.date).getTime()-d)+h);return e}return Math.floor(i.width/2)}).on("mouseover",function(t){var e=d3.time.format(i.dateFormat),o=e(new Date(t.date)),r=""!=o?t.name+" <small>("+o+")</small>":t.name;d3.select(this).style("fill",function(t){return void 0!=t.color?t.color:i.color}).transition().duration(100).attr("r",function(t){return Math.floor(void 0!=t.radius?1.5*t.radius:1.5*i.radius)}),a.html(""),void 0!=t.img&&a.append("img").style("float","center").style("margin-right","4px").attr("src",t.img).attr("width","64px"),a.append("div").style("float","center").html(r),a.transition().duration(100).style("opacity",.9)}).on("mouseout",function(){d3.select(this).style("fill",function(t){return void 0!=t.background?t.background:i.background}).transition().duration(100).attr("r",function(t){return void 0!=t.radius?t.radius:i.radius}),a.transition().duration(100).style("opacity",0)}),0!=i.showLabels){var f=d3.time.format(i.labelFormat),y=f(new Date(d)),p=f(new Date(s));n.append("text").text(y).style("font-size","70%").attr("x",function(){return i.horizontalLayout?d3.max([0,h-this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(){return i.horizontalLayout?Math.floor(i.height/2+(h+this.getBBox().height)):h+this.getBBox().height/2}),n.append("text").text(p).style("font-size","70%").attr("x",function(){return i.horizontalLayout?i.width-d3.max([this.getBBox().width,h+this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(){return i.horizontalLayout?Math.floor(i.height/2+(h+this.getBBox().height)):i.height-h+this.getBBox().height/2})}n.on("mousemove",function(){return tipPixels=parseInt(a.style("height").replace("px","")),a.style("top",d3.event.pageY-tipPixels-h+"px").style("left",d3.event.pageX+3+"px")}).on("mouseout",function(){return a.style("opacity",0).style("top","0px").style("left","0px")})}};